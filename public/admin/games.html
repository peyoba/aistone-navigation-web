<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>游戏管理 - AI Stone 游戏导航</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/admin.css">
  <!-- 引入刷新监控脚本 - 必须放在最前面 -->
  <script src="/js/refresh-monitor.js"></script>
  <!-- 引入数据服务 -->
  <script src="/js/data-service.js"></script>
</head>
<body>
  <header class="main-header">
    <h1 class="site-title">AI Stone 游戏导航 - 游戏管理</h1>
    <nav class="main-nav">
      <a href="/">首页</a>
      <a href="/favorites.html">收藏夹</a>
      <a href="/admin/index.html" class="active">管理</a>
      <button id="toggleLang">English</button>
    </nav>
  </header>
  
  <div class="admin-container">
    <!-- 登录检查提示 -->
    <div id="loginAlert" class="alert alert-warning" style="display: none;">
      您需要先登录才能访问此页面。<a href="/admin/index.html">前往登录</a>
    </div>
    
    <!-- 游戏管理面板 -->
    <div id="gamesPanel" class="admin-panel" style="display: none;">
      <h2 class="admin-title">游戏管理</h2>
      
      <!-- 操作栏 -->
      <div class="admin-actions">
        <div class="search-box">
          <input type="text" id="searchGames" class="form-control" placeholder="搜索游戏...">
        </div>
        <div class="filter-box">
          <select id="categoryFilter" class="form-control">
            <option value="">全部分类</option>
            <!-- 分类选项将通过JS动态加载 -->
          </select>
        </div>
        <div class="action-buttons">
          <button class="btn btn-primary" id="addGameBtn">添加游戏</button>
        </div>
      </div>
      
      <!-- 提示信息区域 -->
      <div id="alertContainer"></div>
      
      <!-- 游戏列表 -->
      <div class="games-table-container">
        <table class="admin-table" id="gamesTable">
          <thead>
            <tr>
              <th style="width: 5%">ID</th>
              <th style="width: 15%">缩略图</th>
              <th style="width: 20%">标题</th>
              <th style="width: 30%">描述</th>
              <th style="width: 10%">分类</th>
              <th style="width: 10%">状态</th>
              <th style="width: 10%">操作</th>
            </tr>
          </thead>
          <tbody id="gamesTableBody">
            <!-- 游戏列表将通过JS动态加载 -->
            <tr>
              <td colspan="7" class="loading">
                <div class="spinner"></div>
                <p>加载游戏数据中...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- 游戏编辑对话框 -->
    <div id="editGameModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>编辑游戏</h3>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <form id="editGameForm" class="admin-form">
            <input type="hidden" id="editGameId">
            
            <div class="form-group">
              <label for="editGameTitleZh">游戏标题（中文）</label>
              <input type="text" id="editGameTitleZh" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="editGameTitleEn">游戏标题（英文）</label>
              <input type="text" id="editGameTitleEn" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="editGameDescZh">游戏描述（中文）</label>
              <textarea id="editGameDescZh" class="form-control" required></textarea>
            </div>
            
            <div class="form-group">
              <label for="editGameDescEn">游戏描述（英文）</label>
              <textarea id="editGameDescEn" class="form-control" required></textarea>
            </div>
            
            <div class="form-group">
              <label for="editGameCategory">游戏分类</label>
              <select id="editGameCategory" class="form-control" required>
                <!-- 分类选项将通过JS动态加载 -->
              </select>
            </div>
            
            <div class="form-group">
              <label for="editGameUrl">游戏链接 (iframe URL)</label>
              <input type="url" id="editGameUrl" class="form-control" required>
            </div>
            
            <div class="form-group">
              <label for="editGameStatus">游戏状态</label>
              <select id="editGameStatus" class="form-control">
                <option value="true">启用</option>
                <option value="false">禁用</option>
              </select>
            </div>
            
            <div class="form-group">
              <button type="submit" class="btn btn-primary">保存更改</button>
              <button type="button" class="btn btn-secondary close-modal">取消</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <!-- 删除确认对话框 -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h3>确认删除</h3>
          <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
          <p>您确定要删除游戏 "<span id="deleteGameName"></span>" 吗？此操作不可撤销。</p>
          <div class="form-group">
            <button id="confirmDeleteBtn" class="btn btn-danger">确认删除</button>
            <button class="btn btn-secondary close-modal">取消</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/js/admin.js"></script>
  <script>
    // 全局变量
    let currentGames = [];
    let currentCategories = [];
    let currentLang = 'zh';
    let isUpdating = false; // 防止更新循环
    
    // 加载状态控制
    const loadingStates = {
      initialized: false,
      dataLoaded: false,
      uiRendered: false
    };
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function() {
      // 检查页面是否已经处理过，防止重复初始化
      if (window._pageInitialized) {
        console.warn("检测到页面重复初始化尝试，已阻止");
        return;
      }
      
      // 标记页面已初始化
      window._pageInitialized = true;
      console.log("管理页面初始化...");
      
      // 初始化数据服务
      await dataService.initialize();
      loadingStates.initialized = true;
      
      // 检查登录状态
      const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
      console.log("管理员登录状态:", isLoggedIn);
      
      if (!isLoggedIn) {
        // 未登录，显示警告
        document.getElementById('loginAlert').style.display = 'block';
      } else {
        // 已登录，显示游戏管理面板
        document.getElementById('gamesPanel').style.display = 'block';
        
        // 获取当前语言
        currentLang = localStorage.getItem('locale') || 'zh';
        
        // 从数据服务加载游戏和分类数据
        loadData();
        
        // 注册数据更新事件监听
        dataService.addEventListener('data-updated', onDataUpdated);
        
        // 初始化搜索和筛选功能
        initSearchAndFilter();
        
        // 初始化编辑对话框
        initEditModal();
        
        // 初始化删除对话框
        initDeleteModal();
        
        // 添加游戏按钮事件
        const addGameBtn = document.getElementById('addGameBtn');
        if (addGameBtn) {
          addGameBtn.addEventListener('click', function() {
            openNewGameModal();
          });
        }
      }
      
      // 初始化语言切换按钮
      const toggleLangButton = document.getElementById('toggleLang');
      if (toggleLangButton) {
        toggleLangButton.textContent = currentLang === 'zh' ? 'English' : '中文';
        toggleLangButton.addEventListener('click', toggleLanguage);
      }
    });
    
    /**
     * 加载数据
     */
    function loadData() {
      // 防止重复加载
      if (isUpdating) {
        console.warn("检测到重复数据加载请求，已忽略");
        return;
      }
      
      isUpdating = true;
      
      try {
        // 从数据服务获取游戏和分类数据
        currentGames = dataService.getAllGames();
        currentCategories = dataService.getAllCategories();
        
        console.log("已加载游戏数据:", currentGames.length, "游戏");
        
        loadingStates.dataLoaded = true;
        
        // 更新UI
        updateUI();
      } catch (error) {
        console.error("加载游戏列表失败:", error);
        showAlert("加载游戏数据失败: " + error.message, "danger");
      } finally {
        // 确保isUpdating标志被重置
        setTimeout(() => {
          isUpdating = false;
        }, 100);
      }
    }
    
    /**
     * 更新UI
     */
    function updateUI() {
      if (!loadingStates.dataLoaded) {
        console.warn("尝试在数据加载前更新UI，已忽略");
        return;
      }
      
      // 更新分类过滤器选项
      updateCategoryFilter();
      
      // 渲染游戏列表
      renderGamesList(currentGames);
      
      loadingStates.uiRendered = true;
    }
    
    /**
     * 数据更新事件处理函数
     */
    function onDataUpdated() {
      console.log("检测到数据更新，刷新游戏列表");
      
      // 防止重复更新
      if (isUpdating) {
        console.warn("检测到重复数据更新请求，已忽略");
        return;
      }
      
      // 重新加载数据
      loadData();
    }
    
    /**
     * 更新分类过滤器选项
     */
    function updateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      if (!categoryFilter) return;
      
      // 清空现有选项（保留第一个"全部分类"选项）
      while (categoryFilter.options.length > 1) {
        categoryFilter.remove(1);
      }
      
      // 添加分类选项
      currentCategories.forEach(category => {
        if (category.id !== 'all') {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name[currentLang] || category.id;
          categoryFilter.appendChild(option);
        }
      });
    }
    
    /**
     * 初始化搜索和过滤功能
     */
    function initSearchAndFilter() {
      const searchInput = document.getElementById('searchGames');
      if (searchInput) {
        searchInput.addEventListener('input', filterGamesList);
      }
      
      const categoryFilter = document.getElementById('categoryFilter');
      if (categoryFilter) {
        categoryFilter.addEventListener('change', filterGamesList);
      }
    }
    
    /**
     * 过滤游戏列表
     */
    function filterGamesList() {
      const searchInput = document.getElementById('searchGames');
      const categoryFilter = document.getElementById('categoryFilter');
      
      if (!searchInput || !categoryFilter) return;
      
      const searchTerm = searchInput.value.toLowerCase();
      const categoryId = categoryFilter.value;
      
      try {
        // 根据搜索词和分类过滤游戏
        const filteredGames = currentGames.filter(game => {
          // 检查游戏对象是否有效
          if (!game || !game.title || !game.description) return false;
          
          const matchesSearch = 
            (game.title.zh && game.title.zh.toLowerCase().includes(searchTerm)) || 
            (game.title.en && game.title.en.toLowerCase().includes(searchTerm)) ||
            (game.description.zh && game.description.zh.toLowerCase().includes(searchTerm)) ||
            (game.description.en && game.description.en.toLowerCase().includes(searchTerm)) ||
            (game.id && game.id.toLowerCase().includes(searchTerm));
            
          const matchesCategory = categoryId ? game.category === categoryId : true;
          
          return matchesSearch && matchesCategory;
        });
        
        renderGamesList(filteredGames);
      } catch (error) {
        console.error("过滤游戏列表失败:", error);
        showAlert("过滤游戏列表时出错", "danger");
      }
    }
    
    /**
     * 渲染游戏列表
     * @param {Array} games 要渲染的游戏数组
     */
    function renderGamesList(games) {
      const tableBody = document.getElementById('gamesTableBody');
      if (!tableBody) return;
      
      try {
        tableBody.innerHTML = '';
        
        if (!games || games.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `
            <td colspan="7" class="text-center">
              <p>没有找到游戏</p>
            </td>
          `;
          tableBody.appendChild(emptyRow);
          return;
        }
        
        // 渲染每个游戏的行
        games.forEach(game => {
          try {
            const row = document.createElement('tr');
            
            // 获取分类名称
            const category = currentCategories.find(c => c.id === game.category);
            const categoryName = category ? 
              (category.name[currentLang] || category.id) : (game.category || '未分类');
            
            // 确保所有属性都有默认值，防止undefined
            const title = game.title?.[currentLang] || game.title?.en || '未命名游戏';
            const description = game.description?.[currentLang] || game.description?.en || '暂无描述';
            const thumbnailSrc = game.thumbnail || '/images/placeholder.jpg';
            const isActive = !!game.active;
            
            row.innerHTML = `
              <td>${game.id || '未知ID'}</td>
              <td>
                <img src="${thumbnailSrc}" 
                     alt="${title}" 
                     class="game-thumbnail" 
                     onerror="this.src='/images/placeholder.jpg'">
              </td>
              <td>${title}</td>
              <td>${description}</td>
              <td>${categoryName}</td>
              <td>
                <span class="status-badge ${isActive ? 'active' : 'inactive'}">
                  ${isActive ? '启用' : '禁用'}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-primary edit-game" data-id="${game.id}">编辑</button>
                <button class="btn btn-sm btn-danger delete-game" data-id="${game.id}">删除</button>
              </td>
            `;
            
            // 添加编辑按钮事件
            const editBtn = row.querySelector('.edit-game');
            if (editBtn) {
              editBtn.addEventListener('click', function() {
                openEditModal(game.id);
              });
            }
            
            // 添加删除按钮事件
            const deleteBtn = row.querySelector('.delete-game');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', function() {
                openDeleteModal(game.id);
              });
            }
            
            tableBody.appendChild(row);
          } catch (error) {
            console.error("渲染游戏行失败:", error, game);
          }
        });
      } catch (error) {
        console.error("渲染游戏列表失败:", error);
        showAlert("渲染游戏列表时出错", "danger");
      }
    }
    
    /**
     * 初始化编辑对话框
     */
    function initEditModal() {
      try {
        // 关闭按钮事件
        document.querySelectorAll('.close-modal').forEach(button => {
          button.addEventListener('click', closeModal);
        });
        
        // 表单提交事件
        const editForm = document.getElementById('editGameForm');
        if (editForm) {
          editForm.addEventListener('submit', function(event) {
            event.preventDefault();
            saveGameChanges();
          });
        }
        
        // 加载分类下拉选项
        loadCategoryOptions();
      } catch (error) {
        console.error("初始化编辑对话框失败:", error);
      }
    }
    
    /**
     * 加载分类下拉选项
     */
    function loadCategoryOptions() {
      const categorySelect = document.getElementById('editGameCategory');
      if (!categorySelect) return;
      
      try {
        categorySelect.innerHTML = '';
        
        // 添加分类选项（排除"all"分类）
        currentCategories.forEach(category => {
          if (category.id !== 'all') {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name[currentLang] || category.id;
            categorySelect.appendChild(option);
          }
        });
      } catch (error) {
        console.error("加载分类选项失败:", error);
      }
    }
    
    /**
     * 打开新游戏添加对话框
     */
    function openNewGameModal() {
      try {
        // 创建新游戏ID（使用时间戳）
        const newGameId = 'game_' + Date.now().toString();
        
        // 重置表单字段
        document.getElementById('editGameId').value = newGameId;
        document.getElementById('editGameTitleZh').value = '';
        document.getElementById('editGameTitleEn').value = '';
        document.getElementById('editGameDescZh').value = '';
        document.getElementById('editGameDescEn').value = '';
        document.getElementById('editGameCategory').value = document.getElementById('editGameCategory').options[0].value;
        document.getElementById('editGameUrl').value = '';
        document.getElementById('editGameStatus').value = 'true';
        
        // 更新对话框标题
        const modalTitle = document.querySelector('#editGameModal .modal-header h3');
        if (modalTitle) {
          modalTitle.textContent = '添加新游戏';
        }
        
        // 显示对话框
        document.getElementById('editGameModal').style.display = 'block';
      } catch (error) {
        console.error("打开新游戏对话框失败:", error);
        showAlert("打开新游戏对话框失败", "danger");
      }
    }
    
    /**
     * 打开编辑对话框
     * @param {string} gameId 游戏ID
     */
    function openEditModal(gameId) {
      try {
        // 查找游戏
        const game = dataService.getGameById(gameId);
        
        if (!game) {
          console.error("找不到要编辑的游戏:", gameId);
          showAlert("找不到要编辑的游戏", "danger");
          return;
        }
        
        // 更新对话框标题
        const modalTitle = document.querySelector('#editGameModal .modal-header h3');
        if (modalTitle) {
          modalTitle.textContent = '编辑游戏';
        }
        
        // 填充表单字段
        document.getElementById('editGameId').value = game.id;
        document.getElementById('editGameTitleZh').value = game.title.zh || '';
        document.getElementById('editGameTitleEn').value = game.title.en || '';
        document.getElementById('editGameDescZh').value = game.description.zh || '';
        document.getElementById('editGameDescEn').value = game.description.en || '';
        document.getElementById('editGameCategory').value = game.category || '';
        document.getElementById('editGameUrl').value = game.iframeUrl || '';
        document.getElementById('editGameStatus').value = game.active.toString();
        
        // 显示对话框
        document.getElementById('editGameModal').style.display = 'block';
      } catch (error) {
        console.error("打开编辑对话框失败:", error);
        showAlert("打开编辑对话框失败: " + error.message, "danger");
      }
    }
    
    /**
     * 关闭所有对话框
     */
    function closeModal() {
      try {
        document.getElementById('editGameModal').style.display = 'none';
        document.getElementById('deleteConfirmModal').style.display = 'none';
      } catch (error) {
        console.error("关闭对话框失败:", error);
      }
    }
    
    /**
     * 保存游戏更改
     */
    function saveGameChanges() {
      try {
        // 收集表单数据
        const gameId = document.getElementById('editGameId').value;
        const titleZh = document.getElementById('editGameTitleZh').value;
        const titleEn = document.getElementById('editGameTitleEn').value;
        const descZh = document.getElementById('editGameDescZh').value;
        const descEn = document.getElementById('editGameDescEn').value;
        const category = document.getElementById('editGameCategory').value;
        const iframeUrl = document.getElementById('editGameUrl').value;
        const active = document.getElementById('editGameStatus').value === 'true';
        
        // 验证必填字段
        if (!gameId || !titleZh || !titleEn || !descZh || !descEn || !category || !iframeUrl) {
          showAlert("请填写所有必填字段", "warning");
          return;
        }
        
        // 查找现有游戏
        const existingGame = dataService.getGameById(gameId);
        const isNewGame = !existingGame;
        
        // 准备游戏数据
        const gameData = {
          id: gameId,
          title: {
            zh: titleZh,
            en: titleEn
          },
          description: {
            zh: descZh,
            en: descEn
          },
          iframeUrl: iframeUrl,
          thumbnail: existingGame ? existingGame.thumbnail : '/images/placeholder.jpg',
          category: category,
          active: active,
          dateAdded: existingGame ? existingGame.dateAdded : new Date().toISOString()
        };
        
        // 保存游戏数据
        const success = dataService.saveGame(gameData);
        
        if (success) {
          showAlert(isNewGame ? "游戏添加成功" : "游戏更新成功", "success");
          closeModal();
          
          // 数据已更新事件会自动触发列表更新
        } else {
          showAlert("保存游戏失败", "danger");
        }
      } catch (error) {
        console.error("保存游戏更改失败:", error);
        showAlert("保存失败: " + error.message, "danger");
      }
    }
    
    /**
     * 初始化删除对话框
     */
    function initDeleteModal() {
      try {
        // 确认删除按钮事件
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        if (confirmBtn) {
          confirmBtn.addEventListener('click', confirmDeleteGame);
        }
      } catch (error) {
        console.error("初始化删除对话框失败:", error);
      }
    }
    
    /**
     * 打开删除确认对话框
     * @param {string} gameId 游戏ID
     */
    function openDeleteModal(gameId) {
      try {
        // 查找游戏
        const game = dataService.getGameById(gameId);
        
        if (!game) {
          console.error("找不到要删除的游戏:", gameId);
          showAlert("找不到要删除的游戏", "danger");
          return;
        }
        
        // 设置游戏ID为确认按钮的数据属性
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.dataset.gameId = gameId;
        
        // 设置游戏名称
        document.getElementById('deleteGameName').textContent = game.title[currentLang] || game.title.en || gameId;
        
        // 显示对话框
        document.getElementById('deleteConfirmModal').style.display = 'block';
      } catch (error) {
        console.error("打开删除对话框失败:", error);
        showAlert("打开删除对话框失败: " + error.message, "danger");
      }
    }
    
    /**
     * 确认删除游戏
     */
    function confirmDeleteGame() {
      try {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const gameId = confirmBtn.dataset.gameId;
        
        if (!gameId) {
          console.error("游戏ID无效");
          return;
        }
        
        // 执行删除
        const success = dataService.deleteGame(gameId);
        
        if (success) {
          showAlert("游戏已成功删除", "success");
          closeModal();
          
          // 数据更新事件会自动触发列表更新
        } else {
          showAlert("删除游戏失败", "danger");
        }
      } catch (error) {
        console.error("删除游戏失败:", error);
        showAlert("删除失败: " + error.message, "danger");
      }
    }
    
    /**
     * 切换语言
     */
    function toggleLanguage() {
      try {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('locale', currentLang);
        
        // 更新语言按钮文本
        const langToggleBtn = document.getElementById('toggleLang');
        if (langToggleBtn) {
          langToggleBtn.textContent = currentLang === 'zh' ? 'English' : '中文';
        }
        
        // 重新加载界面
        loadData();
      } catch (error) {
        console.error("切换语言失败:", error);
        showAlert("切换语言失败", "danger");
      }
    }
    
    /**
     * 显示提示消息
     * @param {string} message 消息内容
     * @param {string} type 消息类型 (success, danger, warning, info)
     */
    function showAlert(message, type = 'info') {
      try {
        const alertContainer = document.getElementById('alertContainer');
        if (!alertContainer) return;
        
        const alertEl = document.createElement('div');
        alertEl.className = `alert alert-${type}`;
        alertEl.innerHTML = `
          ${message}
          <span class="close-alert">&times;</span>
        `;
        
        // 添加关闭按钮事件
        const closeBtn = alertEl.querySelector('.close-alert');
        if (closeBtn) {
          closeBtn.addEventListener('click', function() {
            alertEl.remove();
          });
        }
        
        // 添加到容器
        alertContainer.appendChild(alertEl);
        
        // 5秒后自动关闭
        setTimeout(() => {
          if (alertEl.parentNode) {
            alertEl.remove();
          }
        }, 5000);
      } catch (error) {
        console.error("显示提示消息失败:", error);
      }
    }
  </script>
</body>
</html> 