<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>收藏夹 - AI Stone 游戏导航</title>
  <!-- 引入刷新监控脚本 - 必须放在最前面 -->
  <script src="/js/refresh-monitor.js"></script>
  <!-- 引入数据服务 -->
  <script src="/js/data-service.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="main-header">
    <h1 class="site-title">AI Stone 游戏导航 - 收藏夹</h1>
    <nav class="main-nav">
      <a href="/">首页</a>
      <a href="/favorites.html" class="active">收藏夹</a>
      <a href="/admin/index.html">管理</a>
      <button id="toggleLang">English</button>
    </nav>
  </header>
  
  <div class="container">
    <div class="favorites-header">
      <h2>我的收藏</h2>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="搜索收藏...">
      </div>
    </div>
    
    <div class="empty-favorites" id="emptyFavorites" style="display: none;">
      <div class="empty-message">
        <h3>您的收藏夹为空</h3>
        <p>浏览游戏并点击心形图标将游戏添加到收藏夹</p>
        <a href="/" class="btn btn-primary">探索游戏</a>
      </div>
    </div>
    
    <div class="game-container" id="favoriteGamesContainer">
      <!-- 收藏的游戏将通过JS动态加载 -->
      <div class="loading-message">
        <div class="spinner"></div>
        <p>加载收藏数据中...</p>
      </div>
    </div>
  </div>
  
  <div id="gameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-modal">&times;</span>
        <h2 id="modalGameTitle">游戏标题</h2>
      </div>
      <div class="modal-body">
        <iframe id="gameFrame" src="" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>
  
  <footer class="main-footer">
    <p>&copy; 2023 AI Stone 游戏导航 - 为您带来优质HTML5游戏精选</p>
  </footer>
  
  <script>
    // 全局变量
    let favoriteGames = [];
    let currentLang = 'zh';
    let isUpdating = false; // 防止更新循环
    
    // 加载状态控制
    const loadingStates = {
      initialized: false,
      dataLoaded: false,
      uiRendered: false
    };
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("收藏页面初始化...");
      
      // 检查页面是否已经处理过，防止重复初始化
      if (window._pageInitialized) {
        console.warn("检测到页面重复初始化尝试，已阻止");
        return;
      }
      
      // 标记页面已初始化
      window._pageInitialized = true;
      
      try {
        // 初始化数据服务
        await dataService.initialize();
        loadingStates.initialized = true;
        
        // 获取当前语言
        currentLang = localStorage.getItem('locale') || 'zh';
        
        // 加载收藏数据
        loadFavorites();
        
        // 注册数据更新事件监听
        dataService.addEventListener('favorites-updated', onFavoritesUpdated);
        dataService.addEventListener('data-updated', onDataUpdated);
        
        // 初始化搜索功能
        initSearch();
        
        // 初始化游戏模态框
        initGameModal();
        
        // 切换语言按钮
        const toggleLangBtn = document.getElementById('toggleLang');
        if (toggleLangBtn) {
          toggleLangBtn.addEventListener('click', toggleLanguage);
          
          // 设置按钮文本
          toggleLangBtn.textContent = currentLang === 'zh' ? 'English' : '中文';
        }
      } catch (error) {
        console.error("初始化失败:", error);
        showError("初始化失败: " + error.message);
      }
    });
    
    /**
     * 加载收藏数据
     */
    function loadFavorites() {
      // 防止重复加载
      if (isUpdating) {
        console.warn("检测到重复数据加载请求，已忽略");
        return;
      }
      
      isUpdating = true;
      
      try {
        console.log("加载收藏游戏数据");
        
        // 从数据服务获取收藏游戏
        favoriteGames = dataService.getFavoriteGames();
        
        loadingStates.dataLoaded = true;
        console.log(`已加载 ${favoriteGames.length} 个收藏游戏`);
        
        // 更新UI
        updateUI();
      } catch (error) {
        console.error("加载收藏数据失败:", error);
        showError("加载收藏数据失败: " + error.message);
      } finally {
        // 确保isUpdating标志被重置
        setTimeout(() => {
          isUpdating = false;
        }, 100);
      }
    }
    
    /**
     * 更新UI
     */
    function updateUI() {
      if (!loadingStates.dataLoaded) {
        console.warn("尝试在数据加载前更新UI，已忽略");
        return;
      }
      
      // 渲染收藏游戏
      renderFavoriteGames();
      
      loadingStates.uiRendered = true;
    }
    
    /**
     * 收藏更新事件处理函数
     */
    function onFavoritesUpdated(data) {
      console.log("检测到收藏更新:", data);
      
      // 防止重复更新
      if (isUpdating) {
        console.warn("检测到重复数据更新请求，已忽略");
        return;
      }
      
      // 重新加载收藏数据
      loadFavorites();
    }
    
    /**
     * 数据更新事件处理函数
     */
    function onDataUpdated(data) {
      console.log("检测到数据更新:", data);
      
      // 防止重复更新
      if (isUpdating) {
        console.warn("检测到重复数据更新请求，已忽略");
        return;
      }
      
      // 重新加载收藏数据
      loadFavorites();
    }
    
    /**
     * 渲染收藏游戏
     * @param {string} searchTerm 搜索关键词
     */
    function renderFavoriteGames(searchTerm) {
      try {
        const container = document.getElementById('favoriteGamesContainer');
        const emptyMessage = document.getElementById('emptyFavorites');
        
        if (!container || !emptyMessage) {
          console.error("找不到必要的DOM元素");
          return;
        }
        
        // 清空容器
        container.innerHTML = '';
        
        // 筛选游戏
        let filteredGames = favoriteGames;
        
        // 应用搜索筛选
        if (searchTerm) {
          const searchText = searchTerm.toLowerCase();
          filteredGames = filteredGames.filter(game => {
            return (
              (game.title.zh && game.title.zh.toLowerCase().includes(searchText)) ||
              (game.title.en && game.title.en.toLowerCase().includes(searchText)) ||
              (game.description.zh && game.description.zh.toLowerCase().includes(searchText)) ||
              (game.description.en && game.description.en.toLowerCase().includes(searchText))
            );
          });
        }
        
        // 筛选出活跃游戏
        filteredGames = filteredGames.filter(game => game.active !== false);
        
        // 显示或隐藏空收藏提示
        if (filteredGames.length === 0) {
          container.style.display = 'none';
          emptyMessage.style.display = 'block';
          return;
        } else {
          container.style.display = 'grid';
          emptyMessage.style.display = 'none';
        }
        
        // 创建游戏卡片
        filteredGames.forEach(game => {
          try {
            if (!game || !game.id) return;
            
            // 获取标题和描述
            const title = game.title?.[currentLang] || game.title?.en || 'Unnamed Game';
            const description = game.description?.[currentLang] || game.description?.en || 'No description';
            
            // 创建游戏卡片
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            gameCard.dataset.gameId = game.id;
            
            // 设置卡片内容
            gameCard.innerHTML = `
              <div class="game-thumbnail">
                <img src="${game.thumbnail || '/images/placeholder.jpg'}" alt="${title}" onerror="this.src='/images/placeholder.jpg'">
                <div class="game-overlay">
                  <button class="play-button">Play</button>
                </div>
              </div>
              <div class="game-info">
                <h3 class="game-title">${title}</h3>
                <p class="game-description">${description}</p>
              </div>
              <div class="game-actions">
                <button class="favorite-button active">
                  <span class="heart-icon">❤</span>
                </button>
              </div>
            `;
            
            // 添加播放按钮事件
            const playButton = gameCard.querySelector('.play-button');
            if (playButton) {
              playButton.addEventListener('click', function(e) {
                e.stopPropagation();
                openGameModal(game);
              });
            }
            
            // 添加卡片点击事件
            gameCard.addEventListener('click', function() {
              openGameModal(game);
            });
            
            // 添加收藏按钮事件
            const favoriteButton = gameCard.querySelector('.favorite-button');
            if (favoriteButton) {
              favoriteButton.addEventListener('click', function(e) {
                e.stopPropagation();
                removeFromFavorites(game.id);
              });
            }
            
            // 添加到容器
            container.appendChild(gameCard);
          } catch (error) {
            console.error("渲染游戏卡片失败:", error, game);
          }
        });
      } catch (error) {
        console.error("渲染收藏游戏失败:", error);
        showError("渲染收藏游戏失败");
      }
    }
    
    /**
     * 从收藏中移除游戏
     * @param {string} gameId 游戏ID
     */
    function removeFromFavorites(gameId) {
      try {
        // 从收藏中移除游戏
        const success = dataService.removeGameFromFavorites(gameId);
        
        if (success) {
          // 从当前列表中移除
          favoriteGames = favoriteGames.filter(game => game.id !== gameId);
          
          // 重新渲染
          renderFavoriteGames(document.getElementById('searchInput').value);
        }
      } catch (error) {
        console.error("移除收藏失败:", error);
      }
    }
    
    /**
     * 初始化搜索功能
     */
    function initSearch() {
      try {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            renderFavoriteGames(this.value);
          });
        }
      } catch (error) {
        console.error("初始化搜索功能失败:", error);
      }
    }
    
    /**
     * 初始化游戏模态框
     */
    function initGameModal() {
      try {
        const modal = document.getElementById('gameModal');
        const closeBtn = modal.querySelector('.close-modal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', function() {
            closeGameModal();
          });
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeGameModal();
          }
        });
        
        // ESC键关闭
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            closeGameModal();
          }
        });
      } catch (error) {
        console.error("初始化游戏模态框失败:", error);
      }
    }
    
    /**
     * 打开游戏模态框
     * @param {Object} game 游戏对象
     */
    function openGameModal(game) {
      try {
        if (!game || !game.iframeUrl) {
          console.error("游戏数据不完整，无法打开", game);
          return;
        }
        
        const modal = document.getElementById('gameModal');
        const titleElement = document.getElementById('modalGameTitle');
        const gameFrame = document.getElementById('gameFrame');
        
        if (!modal || !titleElement || !gameFrame) {
          console.error("找不到模态框元素");
          return;
        }
        
        // 设置标题
        titleElement.textContent = game.title[currentLang] || game.title.en || game.id;
        
        // 设置iframe源
        gameFrame.src = game.iframeUrl;
        
        // 显示模态框
        modal.style.display = 'block';
        
        // 阻止页面滚动
        document.body.style.overflow = 'hidden';
      } catch (error) {
        console.error("打开游戏模态框失败:", error);
      }
    }
    
    /**
     * 关闭游戏模态框
     */
    function closeGameModal() {
      try {
        const modal = document.getElementById('gameModal');
        const gameFrame = document.getElementById('gameFrame');
        
        if (!modal || !gameFrame) return;
        
        // 清空iframe源，避免游戏继续运行
        gameFrame.src = '';
        
        // 隐藏模态框
        modal.style.display = 'none';
        
        // 恢复页面滚动
        document.body.style.overflow = 'auto';
      } catch (error) {
        console.error("关闭游戏模态框失败:", error);
      }
    }
    
    /**
     * 切换语言
     */
    function toggleLanguage() {
      try {
        // 切换语言
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        
        // 保存语言设置
        localStorage.setItem('locale', currentLang);
        
        // 更新语言按钮文本
        const toggleLangBtn = document.getElementById('toggleLang');
        if (toggleLangBtn) {
          toggleLangBtn.textContent = currentLang === 'zh' ? 'English' : '中文';
        }
        
        // 更新界面
        updateUI();
      } catch (error) {
        console.error("切换语言失败:", error);
      }
    }
    
    /**
     * 显示错误消息
     * @param {string} message 错误消息
     */
    function showError(message) {
      try {
        const container = document.getElementById('favoriteGamesContainer');
        if (!container) return;
        
        container.innerHTML = `
          <div class="error-message">
            <p>😢 ${message}</p>
            <button onclick="loadFavorites()">重试</button>
          </div>
        `;
        
        const emptyMessage = document.getElementById('emptyFavorites');
        if (emptyMessage) {
          emptyMessage.style.display = 'none';
        }
        
        container.style.display = 'block';
      } catch (error) {
        console.error("显示错误消息失败:", error);
      }
    }
  </script>
</body>
</html> 