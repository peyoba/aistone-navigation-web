<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ”¶è—å¤¹ - AI Stone æ¸¸æˆå¯¼èˆª</title>
  <!-- å¼•å…¥åˆ·æ–°ç›‘æ§è„šæœ¬ - å¿…é¡»æ”¾åœ¨æœ€å‰é¢ -->
  <script src="/js/refresh-monitor.js"></script>
  <!-- å¼•å…¥æ•°æ®æœåŠ¡ -->
  <script src="/js/data-service.js"></script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header class="main-header">
    <h1 class="site-title">AI Stone æ¸¸æˆå¯¼èˆª - æ”¶è—å¤¹</h1>
    <nav class="main-nav">
      <a href="/">é¦–é¡µ</a>
      <a href="/favorites.html" class="active">æ”¶è—å¤¹</a>
      <a href="/admin/index.html">ç®¡ç†</a>
      <button id="toggleLang">English</button>
    </nav>
  </header>
  
  <div class="container">
    <div class="favorites-header">
      <h2>æˆ‘çš„æ”¶è—</h2>
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="æœç´¢æ”¶è—...">
      </div>
    </div>
    
    <div class="empty-favorites" id="emptyFavorites" style="display: none;">
      <div class="empty-message">
        <h3>æ‚¨çš„æ”¶è—å¤¹ä¸ºç©º</h3>
        <p>æµè§ˆæ¸¸æˆå¹¶ç‚¹å‡»å¿ƒå½¢å›¾æ ‡å°†æ¸¸æˆæ·»åŠ åˆ°æ”¶è—å¤¹</p>
        <a href="/" class="btn btn-primary">æ¢ç´¢æ¸¸æˆ</a>
      </div>
    </div>
    
    <div class="game-container" id="favoriteGamesContainer">
      <!-- æ”¶è—çš„æ¸¸æˆå°†é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
      <div class="loading-message">
        <div class="spinner"></div>
        <p>åŠ è½½æ”¶è—æ•°æ®ä¸­...</p>
      </div>
    </div>
  </div>
  
  <div id="gameModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close-modal">&times;</span>
        <h2 id="modalGameTitle">æ¸¸æˆæ ‡é¢˜</h2>
      </div>
      <div class="modal-body">
        <iframe id="gameFrame" src="" frameborder="0" allowfullscreen></iframe>
      </div>
    </div>
  </div>
  
  <footer class="main-footer">
    <p>&copy; 2023 AI Stone æ¸¸æˆå¯¼èˆª - ä¸ºæ‚¨å¸¦æ¥ä¼˜è´¨HTML5æ¸¸æˆç²¾é€‰</p>
  </footer>
  
  <script>
    // å…¨å±€å˜é‡
    let favoriteGames = [];
    let currentLang = 'zh';
    let isUpdating = false; // é˜²æ­¢æ›´æ–°å¾ªç¯
    
    // åŠ è½½çŠ¶æ€æ§åˆ¶
    const loadingStates = {
      initialized: false,
      dataLoaded: false,
      uiRendered: false
    };
    
    // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', async function() {
      console.log("æ”¶è—é¡µé¢åˆå§‹åŒ–...");
      
      // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²ç»å¤„ç†è¿‡ï¼Œé˜²æ­¢é‡å¤åˆå§‹åŒ–
      if (window._pageInitialized) {
        console.warn("æ£€æµ‹åˆ°é¡µé¢é‡å¤åˆå§‹åŒ–å°è¯•ï¼Œå·²é˜»æ­¢");
        return;
      }
      
      // æ ‡è®°é¡µé¢å·²åˆå§‹åŒ–
      window._pageInitialized = true;
      
      try {
        // åˆå§‹åŒ–æ•°æ®æœåŠ¡
        await dataService.initialize();
        loadingStates.initialized = true;
        
        // è·å–å½“å‰è¯­è¨€
        currentLang = localStorage.getItem('locale') || 'zh';
        
        // åŠ è½½æ”¶è—æ•°æ®
        loadFavorites();
        
        // æ³¨å†Œæ•°æ®æ›´æ–°äº‹ä»¶ç›‘å¬
        dataService.addEventListener('favorites-updated', onFavoritesUpdated);
        dataService.addEventListener('data-updated', onDataUpdated);
        
        // åˆå§‹åŒ–æœç´¢åŠŸèƒ½
        initSearch();
        
        // åˆå§‹åŒ–æ¸¸æˆæ¨¡æ€æ¡†
        initGameModal();
        
        // åˆ‡æ¢è¯­è¨€æŒ‰é’®
        const toggleLangBtn = document.getElementById('toggleLang');
        if (toggleLangBtn) {
          toggleLangBtn.addEventListener('click', toggleLanguage);
          
          // è®¾ç½®æŒ‰é’®æ–‡æœ¬
          toggleLangBtn.textContent = currentLang === 'zh' ? 'English' : 'ä¸­æ–‡';
        }
      } catch (error) {
        console.error("åˆå§‹åŒ–å¤±è´¥:", error);
        showError("åˆå§‹åŒ–å¤±è´¥: " + error.message);
      }
    });
    
    /**
     * åŠ è½½æ”¶è—æ•°æ®
     */
    function loadFavorites() {
      // é˜²æ­¢é‡å¤åŠ è½½
      if (isUpdating) {
        console.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®åŠ è½½è¯·æ±‚ï¼Œå·²å¿½ç•¥");
        return;
      }
      
      isUpdating = true;
      
      try {
        console.log("åŠ è½½æ”¶è—æ¸¸æˆæ•°æ®");
        
        // ä»æ•°æ®æœåŠ¡è·å–æ”¶è—æ¸¸æˆ
        favoriteGames = dataService.getFavoriteGames();
        
        loadingStates.dataLoaded = true;
        console.log(`å·²åŠ è½½ ${favoriteGames.length} ä¸ªæ”¶è—æ¸¸æˆ`);
        
        // æ›´æ–°UI
        updateUI();
      } catch (error) {
        console.error("åŠ è½½æ”¶è—æ•°æ®å¤±è´¥:", error);
        showError("åŠ è½½æ”¶è—æ•°æ®å¤±è´¥: " + error.message);
      } finally {
        // ç¡®ä¿isUpdatingæ ‡å¿—è¢«é‡ç½®
        setTimeout(() => {
          isUpdating = false;
        }, 100);
      }
    }
    
    /**
     * æ›´æ–°UI
     */
    function updateUI() {
      if (!loadingStates.dataLoaded) {
        console.warn("å°è¯•åœ¨æ•°æ®åŠ è½½å‰æ›´æ–°UIï¼Œå·²å¿½ç•¥");
        return;
      }
      
      // æ¸²æŸ“æ”¶è—æ¸¸æˆ
      renderFavoriteGames();
      
      loadingStates.uiRendered = true;
    }
    
    /**
     * æ”¶è—æ›´æ–°äº‹ä»¶å¤„ç†å‡½æ•°
     */
    function onFavoritesUpdated(data) {
      console.log("æ£€æµ‹åˆ°æ”¶è—æ›´æ–°:", data);
      
      // é˜²æ­¢é‡å¤æ›´æ–°
      if (isUpdating) {
        console.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®æ›´æ–°è¯·æ±‚ï¼Œå·²å¿½ç•¥");
        return;
      }
      
      // é‡æ–°åŠ è½½æ”¶è—æ•°æ®
      loadFavorites();
    }
    
    /**
     * æ•°æ®æ›´æ–°äº‹ä»¶å¤„ç†å‡½æ•°
     */
    function onDataUpdated(data) {
      console.log("æ£€æµ‹åˆ°æ•°æ®æ›´æ–°:", data);
      
      // é˜²æ­¢é‡å¤æ›´æ–°
      if (isUpdating) {
        console.warn("æ£€æµ‹åˆ°é‡å¤æ•°æ®æ›´æ–°è¯·æ±‚ï¼Œå·²å¿½ç•¥");
        return;
      }
      
      // é‡æ–°åŠ è½½æ”¶è—æ•°æ®
      loadFavorites();
    }
    
    /**
     * æ¸²æŸ“æ”¶è—æ¸¸æˆ
     * @param {string} searchTerm æœç´¢å…³é”®è¯
     */
    function renderFavoriteGames(searchTerm) {
      try {
        const container = document.getElementById('favoriteGamesContainer');
        const emptyMessage = document.getElementById('emptyFavorites');
        
        if (!container || !emptyMessage) {
          console.error("æ‰¾ä¸åˆ°å¿…è¦çš„DOMå…ƒç´ ");
          return;
        }
        
        // æ¸…ç©ºå®¹å™¨
        container.innerHTML = '';
        
        // ç­›é€‰æ¸¸æˆ
        let filteredGames = favoriteGames;
        
        // åº”ç”¨æœç´¢ç­›é€‰
        if (searchTerm) {
          const searchText = searchTerm.toLowerCase();
          filteredGames = filteredGames.filter(game => {
            return (
              (game.title.zh && game.title.zh.toLowerCase().includes(searchText)) ||
              (game.title.en && game.title.en.toLowerCase().includes(searchText)) ||
              (game.description.zh && game.description.zh.toLowerCase().includes(searchText)) ||
              (game.description.en && game.description.en.toLowerCase().includes(searchText))
            );
          });
        }
        
        // ç­›é€‰å‡ºæ´»è·ƒæ¸¸æˆ
        filteredGames = filteredGames.filter(game => game.active !== false);
        
        // æ˜¾ç¤ºæˆ–éšè—ç©ºæ”¶è—æç¤º
        if (filteredGames.length === 0) {
          container.style.display = 'none';
          emptyMessage.style.display = 'block';
          return;
        } else {
          container.style.display = 'grid';
          emptyMessage.style.display = 'none';
        }
        
        // åˆ›å»ºæ¸¸æˆå¡ç‰‡
        filteredGames.forEach(game => {
          try {
            if (!game || !game.id) return;
            
            // è·å–æ ‡é¢˜å’Œæè¿°
            const title = game.title?.[currentLang] || game.title?.en || 'Unnamed Game';
            const description = game.description?.[currentLang] || game.description?.en || 'No description';
            
            // åˆ›å»ºæ¸¸æˆå¡ç‰‡
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            gameCard.dataset.gameId = game.id;
            
            // è®¾ç½®å¡ç‰‡å†…å®¹
            gameCard.innerHTML = `
              <div class="game-thumbnail">
                <img src="${game.thumbnail || '/images/placeholder.jpg'}" alt="${title}" onerror="this.src='/images/placeholder.jpg'">
                <div class="game-overlay">
                  <button class="play-button">Play</button>
                </div>
              </div>
              <div class="game-info">
                <h3 class="game-title">${title}</h3>
                <p class="game-description">${description}</p>
              </div>
              <div class="game-actions">
                <button class="favorite-button active">
                  <span class="heart-icon">â¤</span>
                </button>
              </div>
            `;
            
            // æ·»åŠ æ’­æ”¾æŒ‰é’®äº‹ä»¶
            const playButton = gameCard.querySelector('.play-button');
            if (playButton) {
              playButton.addEventListener('click', function(e) {
                e.stopPropagation();
                openGameModal(game);
              });
            }
            
            // æ·»åŠ å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            gameCard.addEventListener('click', function() {
              openGameModal(game);
            });
            
            // æ·»åŠ æ”¶è—æŒ‰é’®äº‹ä»¶
            const favoriteButton = gameCard.querySelector('.favorite-button');
            if (favoriteButton) {
              favoriteButton.addEventListener('click', function(e) {
                e.stopPropagation();
                removeFromFavorites(game.id);
              });
            }
            
            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(gameCard);
          } catch (error) {
            console.error("æ¸²æŸ“æ¸¸æˆå¡ç‰‡å¤±è´¥:", error, game);
          }
        });
      } catch (error) {
        console.error("æ¸²æŸ“æ”¶è—æ¸¸æˆå¤±è´¥:", error);
        showError("æ¸²æŸ“æ”¶è—æ¸¸æˆå¤±è´¥");
      }
    }
    
    /**
     * ä»æ”¶è—ä¸­ç§»é™¤æ¸¸æˆ
     * @param {string} gameId æ¸¸æˆID
     */
    function removeFromFavorites(gameId) {
      try {
        // ä»æ”¶è—ä¸­ç§»é™¤æ¸¸æˆ
        const success = dataService.removeGameFromFavorites(gameId);
        
        if (success) {
          // ä»å½“å‰åˆ—è¡¨ä¸­ç§»é™¤
          favoriteGames = favoriteGames.filter(game => game.id !== gameId);
          
          // é‡æ–°æ¸²æŸ“
          renderFavoriteGames(document.getElementById('searchInput').value);
        }
      } catch (error) {
        console.error("ç§»é™¤æ”¶è—å¤±è´¥:", error);
      }
    }
    
    /**
     * åˆå§‹åŒ–æœç´¢åŠŸèƒ½
     */
    function initSearch() {
      try {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            renderFavoriteGames(this.value);
          });
        }
      } catch (error) {
        console.error("åˆå§‹åŒ–æœç´¢åŠŸèƒ½å¤±è´¥:", error);
      }
    }
    
    /**
     * åˆå§‹åŒ–æ¸¸æˆæ¨¡æ€æ¡†
     */
    function initGameModal() {
      try {
        const modal = document.getElementById('gameModal');
        const closeBtn = modal.querySelector('.close-modal');
        
        if (closeBtn) {
          closeBtn.addEventListener('click', function() {
            closeGameModal();
          });
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            closeGameModal();
          }
        });
        
        // ESCé”®å…³é—­
        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape') {
            closeGameModal();
          }
        });
      } catch (error) {
        console.error("åˆå§‹åŒ–æ¸¸æˆæ¨¡æ€æ¡†å¤±è´¥:", error);
      }
    }
    
    /**
     * æ‰“å¼€æ¸¸æˆæ¨¡æ€æ¡†
     * @param {Object} game æ¸¸æˆå¯¹è±¡
     */
    function openGameModal(game) {
      try {
        if (!game || !game.iframeUrl) {
          console.error("æ¸¸æˆæ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•æ‰“å¼€", game);
          return;
        }
        
        const modal = document.getElementById('gameModal');
        const titleElement = document.getElementById('modalGameTitle');
        const gameFrame = document.getElementById('gameFrame');
        
        if (!modal || !titleElement || !gameFrame) {
          console.error("æ‰¾ä¸åˆ°æ¨¡æ€æ¡†å…ƒç´ ");
          return;
        }
        
        // è®¾ç½®æ ‡é¢˜
        titleElement.textContent = game.title[currentLang] || game.title.en || game.id;
        
        // è®¾ç½®iframeæº
        gameFrame.src = game.iframeUrl;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        modal.style.display = 'block';
        
        // é˜»æ­¢é¡µé¢æ»šåŠ¨
        document.body.style.overflow = 'hidden';
      } catch (error) {
        console.error("æ‰“å¼€æ¸¸æˆæ¨¡æ€æ¡†å¤±è´¥:", error);
      }
    }
    
    /**
     * å…³é—­æ¸¸æˆæ¨¡æ€æ¡†
     */
    function closeGameModal() {
      try {
        const modal = document.getElementById('gameModal');
        const gameFrame = document.getElementById('gameFrame');
        
        if (!modal || !gameFrame) return;
        
        // æ¸…ç©ºiframeæºï¼Œé¿å…æ¸¸æˆç»§ç»­è¿è¡Œ
        gameFrame.src = '';
        
        // éšè—æ¨¡æ€æ¡†
        modal.style.display = 'none';
        
        // æ¢å¤é¡µé¢æ»šåŠ¨
        document.body.style.overflow = 'auto';
      } catch (error) {
        console.error("å…³é—­æ¸¸æˆæ¨¡æ€æ¡†å¤±è´¥:", error);
      }
    }
    
    /**
     * åˆ‡æ¢è¯­è¨€
     */
    function toggleLanguage() {
      try {
        // åˆ‡æ¢è¯­è¨€
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        
        // ä¿å­˜è¯­è¨€è®¾ç½®
        localStorage.setItem('locale', currentLang);
        
        // æ›´æ–°è¯­è¨€æŒ‰é’®æ–‡æœ¬
        const toggleLangBtn = document.getElementById('toggleLang');
        if (toggleLangBtn) {
          toggleLangBtn.textContent = currentLang === 'zh' ? 'English' : 'ä¸­æ–‡';
        }
        
        // æ›´æ–°ç•Œé¢
        updateUI();
      } catch (error) {
        console.error("åˆ‡æ¢è¯­è¨€å¤±è´¥:", error);
      }
    }
    
    /**
     * æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
     * @param {string} message é”™è¯¯æ¶ˆæ¯
     */
    function showError(message) {
      try {
        const container = document.getElementById('favoriteGamesContainer');
        if (!container) return;
        
        container.innerHTML = `
          <div class="error-message">
            <p>ğŸ˜¢ ${message}</p>
            <button onclick="loadFavorites()">é‡è¯•</button>
          </div>
        `;
        
        const emptyMessage = document.getElementById('emptyFavorites');
        if (emptyMessage) {
          emptyMessage.style.display = 'none';
        }
        
        container.style.display = 'block';
      } catch (error) {
        console.error("æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¤±è´¥:", error);
      }
    }
  </script>
</body>
</html> 